#!/usr/bin/env bash

BLUE="\033[0;34m"
CYAN="\033[0;36m"
PURPLE="\033[0;35m"
NO_COLOR="\033[0m"

set -euo pipefail

function run() {
  INSTALL_PATH=/var/lib
  AV_PATH=$INSTALL_PATH/aviary/av
  GIT_URL=https://github.com/team-video/aviary.sh.git
  INVENTORY_GIT_URL="https://github.com/P5vc/ServerConfigurations.git"
  CONFIG_FILE=${INSTALL_PATH}/aviary/config
  CONFIG_FILE_URL="https://raw.githubusercontent.com/P5vc/ServerConfigurations/master/config"

  # Set hostname variable:
  echo -e "\n\n${BLUE}A hostname matching one of the valid options under the hosts\ndirectory must be set for this server. This hostname must\nbe unique.\n\n${CYAN}Desired Hostname: ${NO_COLOR}"
  read serverHostname
  echo -e "\n\n${PURPLE}The server's new hostname will be: ${serverHostname}${NO_COLOR}"

  # Set public IP variable:
  echo -e "\n\n${BLUE}In order to properly configure this server, it's public IPv4\naddress is required.\n\n${CYAN}Public IPv4 Address: ${NO_COLOR}"
  read serverPubIPv4
  echo -e "\n\n${PURPLE}The server's public IPv4 address has been set to: ${serverPubIPv4}${NO_COLOR}"

  # Set FQDN variable:
  echo -e "\n\n${BLUE}In order to properly configure this server, it's associated\nfully-qualified domain name is required. This is most likely 'Priveasy.org' or 'P5.vc'.\n\n${CYAN}FQDN: ${NO_COLOR}"
  read serverFQDN
  echo -e "\n\n${PURPLE}The server's FQDn has been set to: ${serverFQDN}${NO_COLOR}\n\n"


  # check for git dependency
  if ! /usr/bin/which git > /dev/null; then
    apt-get update
    apt-get install git -y
  fi

  if [[ -e /var/lib/aviary ]]; then 
    echo "Found existing installation at $INSTALL_PATH; exiting"
    exit 1
  fi

  echo Installing to ${INSTALL_PATH}...
  mkdir -p ${INSTALL_PATH}/aviary
  git clone $GIT_URL ${INSTALL_PATH}/aviary
  ln -sf /var/lib/aviary/av /usr/bin/av
  mkdir -p ${INSTALL_PATH}/aviary/inventory

  if [[ -z "$INVENTORY_GIT_URL" ]]
    then
      echo "Installing with no inventory git url; set later in $CONFIG_FILE"
    else
      git clone $INVENTORY_GIT_URL ${INSTALL_PATH}/aviary/inventory/
  fi

  cp ${INSTALL_PATH}/aviary/inventory/config ${INSTALL_PATH}/aviary/config

  # Save set variables:
  echo "serverHostname=${serverHostname}" >> ${INSTALL_PATH}/aviary/variables
  echo "serverPubIPv4=${serverPubIPv4}" >> ${INSTALL_PATH}/aviary/variables
  echo "serverFQDN=${serverFQDN}" >> ${INSTALL_PATH}/aviary/variables

  echo Adding entry to /etc/crontab...
  echo "$(cat /etc/crontab | grep -v $AV_PATH)" > /etc/crontab
  echo "$(( RANDOM % 60 )) $(( RANDOM % 60 )) * * * root $AV_PATH directive >> /var/log/aviary-directive.log 2>&1" >> /etc/crontab
  echo "$(( RANDOM % 60 )) $(( RANDOM % 60 )) * * * root $AV_PATH apply >> /var/log/aviary.log 2>&1" >> /etc/crontab

  echo Done
}

run  # Wrap in function to ensure entire script is downloaded.
